name: push docker image

on:
    push:
        branches: 'main'


jobs:
    build-cuda-image:
        runs-on: ubuntu-latest

        steps:
          - name: checkout
            uses: actions/checkout@v3

          - name: dockerhub login
            uses: docker/login-action@v1
            with:
              username: ${{ secrets.DOCKER_USERNAME }}
              password: ${{ secrets.DOCKER_PASSWORD }}

          - name: docker buildx setup
            uses: docker/setup-buildx-action@v1
        
          - name: build and push
            uses: docker/build-push-action@v2
            with:
              context: ./
              file: ./docker/Dockerfile
              builder: ${{ steps.buildx.outputs.name }}
              push: true
              tags: ${{ secrets.DOCKER_USERNAME }}/justdeepit:autobuild
              cache-from: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/justdeepit:buildcache
              cache-to: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/justdeepit:buildcache,mode=max

